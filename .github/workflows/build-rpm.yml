name: Build RPM

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install RPM tools
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: Get version
        id: version
        run: echo "version=$(grep -oP '__version__ = "\K[^"]+' src/elementary_l10n/__init__.py)" >> $GITHUB_OUTPUT

      - name: Build RPM
        env:
          VERSION: ${{ steps.version.outputs.version }}
        shell: python3 {0}
        run: |
          import os, subprocess, textwrap, datetime
          version = os.environ["VERSION"]
          pkg = f"elementary-l10n-{version}"
          home = os.path.expanduser("~")

          for d in ["BUILD","RPMS","SOURCES","SPECS","SRPMS"]:
              os.makedirs(f"{home}/rpmbuild/{d}", exist_ok=True)

          os.makedirs(f"{pkg}/src/elementary_l10n", exist_ok=True)
          os.makedirs(f"{pkg}/data/icons", exist_ok=True)
          os.makedirs(f"{pkg}/data/man", exist_ok=True)
          subprocess.run(f"cp src/elementary_l10n/*.py {pkg}/src/elementary_l10n/", shell=True, check=True)
          subprocess.run(f"cp data/se.danielnylander.TranslationStatus.desktop {pkg}/data/", shell=True, check=True)
          subprocess.run(f"cp data/icons/elementary-l10n.svg data/icons/se.danielnylander.elementary-l10n.svg {pkg}/data/icons/", shell=True, check=True)
          subprocess.run(f"cp data/man/elementary-l10n.1 {pkg}/data/man/", shell=True, check=True)
          subprocess.run(f"cp data/se.danielnylander.TranslationStatus.metainfo.xml {pkg}/data/", shell=True, check=True)
          subprocess.run(f"cp COPYING {pkg}/", shell=True, check=True)
          subprocess.run(f"test -d locale && cp -r locale {pkg}/ || true", shell=True, check=True)
          subprocess.run(f"tar czf {home}/rpmbuild/SOURCES/elementary-l10n-{version}.tar.gz {pkg}", shell=True, check=True)

          today = datetime.datetime.now().strftime("%a %b %d %Y")
          spec = textwrap.dedent(f"""\
          Name:           elementary-l10n
          Version:        {version}
          Release:        1
          Summary:        elementary-l10n
          License:        GPL-3.0-or-later
          URL:            https://github.com/yeager/elementary-l10n
          Source0:        %{{name}}-%{{version}}.tar.gz
          BuildArch:      noarch
          Requires:       python3 >= 3.9
          Requires:       python3-gobject
          Requires:       gtk4
          Requires:       libadwaita
          Requires:       python3-requests

          %description
          elementary-l10n application.

          %prep
          %setup -q

          %install
          mkdir -p %{{buildroot}}%{{_datadir}}/elementary-l10n
          cp src/elementary_l10n/*.py %{{buildroot}}%{{_datadir}}/elementary-l10n/
          mkdir -p %{{buildroot}}%{{_bindir}}
          cat > %{{buildroot}}%{{_bindir}}/elementary-l10n << 'WRAPPER'
          #!/bin/bash
          exec python3 %{{_datadir}}/elementary-l10n/app.py "$@"
          WRAPPER
          chmod 755 %{{buildroot}}%{{_bindir}}/elementary-l10n
          install -Dm644 data/se.danielnylander.TranslationStatus.desktop %{{buildroot}}%{{_datadir}}/applications/se.danielnylander.TranslationStatus.desktop
          install -Dm644 data/icons/elementary-l10n.svg %{{buildroot}}%{{_datadir}}/icons/hicolor/scalable/apps/elementary-l10n.svg
          install -Dm644 data/icons/se.danielnylander.elementary-l10n.svg %{{buildroot}}%{{_datadir}}/icons/hicolor/scalable/apps/se.danielnylander.elementary-l10n.svg
          install -Dm644 data/man/elementary-l10n.1 %{{buildroot}}%{{_mandir}}/man1/elementary-l10n.1
          install -Dm644 data/se.danielnylander.TranslationStatus.metainfo.xml %{{buildroot}}%{{_datadir}}/metainfo/se.danielnylander.TranslationStatus.metainfo.xml
          if [ -d locale ]; then
            for mo in locale/*/LC_MESSAGES/*.mo; do
              [ -f "$mo" ] || continue
              lang=$(echo "$mo" | cut -d/ -f2)
              install -Dm644 "$mo" "%{{buildroot}}%{{_datadir}}/locale/$lang/LC_MESSAGES/elementary-l10n.mo"
            done
          fi

          %files
          %license COPYING
          %{{_bindir}}/elementary-l10n
          %{{_datadir}}/elementary-l10n/
          %{{_datadir}}/applications/se.danielnylander.TranslationStatus.desktop
          %{{_datadir}}/icons/hicolor/scalable/apps/elementary-l10n.svg
          %{{_datadir}}/icons/hicolor/scalable/apps/se.danielnylander.elementary-l10n.svg
          %{{_mandir}}/man1/elementary-l10n.1*
          %{{_datadir}}/metainfo/se.danielnylander.TranslationStatus.metainfo.xml

          %changelog
          * {today} Daniel Nylander <daniel@danielnylander.se> - {version}-1
          - RPM package
          """)
          with open(f"{home}/rpmbuild/SPECS/elementary-l10n.spec", "w") as f:
              f.write(spec)

          subprocess.run(["rpmbuild", "-ba", f"{home}/rpmbuild/SPECS/elementary-l10n.spec"], check=True)

      - name: Upload RPM to release
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          gh release upload "v${VERSION}" \
            ~/rpmbuild/RPMS/noarch/elementary-l10n-${VERSION}-1.noarch.rpm \
            --clobber
