name: Build RPM

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install RPM tools
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: Get version
        id: version
        run: echo "version=$(grep -oP '__version__ = "\K[^"]+' src/elementary_l10n/__init__.py)" >> $GITHUB_OUTPUT

      - name: Setup RPM build
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          VERSION=${{ steps.version.outputs.version }}
          DIR=elementary-l10n-$VERSION
          mkdir -p $DIR/src/elementary_l10n
          mkdir -p $DIR/data/icons $DIR/data/man
          cp src/elementary_l10n/*.py $DIR/src/elementary_l10n/
          cp data/se.danielnylander.TranslationStatus.desktop $DIR/data/
          cp data/icons/se.danielnylander.elementary-l10n.svg $DIR/data/icons/
          cp data/icons/elementary-l10n.svg $DIR/data/icons/
          cp data/man/elementary-l10n.1 $DIR/data/man/
          cp data/se.danielnylander.TranslationStatus.metainfo.xml $DIR/data/
          cp COPYING $DIR/
          test -f po/sv/LC_MESSAGES/elementary-l10n.mo && { mkdir -p $DIR/po/sv/LC_MESSAGES; cp po/sv/LC_MESSAGES/elementary-l10n.mo $DIR/po/sv/LC_MESSAGES/; } || true
          tar czf ~/rpmbuild/SOURCES/$DIR.tar.gz $DIR

      - name: Create spec file
        run: |
          cat > ~/rpmbuild/SPECS/elementary-l10n.spec << 'SPEC'
          Name:           elementary-l10n
          Version:        VERSION_PLACEHOLDER
          Release:        1
          Summary:        elementary OS translation status viewer
          License:        GPL-3.0-or-later
          URL:            https://github.com/yeager/elementary-l10n
          Source0:        %{name}-%{version}.tar.gz
          BuildArch:      noarch
          Requires:       python3 >= 3.9
          Requires:       python3-gobject
          Requires:       gtk4
          Requires:       libadwaita
          Requires:       python3-requests

          %description
          A GTK4/Libadwaita application for viewing elementary OS translation status.

          %prep
          %setup -q

          %install
          mkdir -p %{buildroot}%{_datadir}/elementary-l10n/elementary_l10n
          cp src/elementary_l10n/*.py %{buildroot}%{_datadir}/elementary-l10n/elementary_l10n/
          mkdir -p %{buildroot}%{_bindir}
          cat > %{buildroot}%{_bindir}/elementary-l10n << 'WRAPPER'
          #!/bin/bash
          exec python3 -c "import sys; sys.path.insert(0, '/usr/share/elementary-l10n'); from elementary_l10n.app import main; main()" "$@"
          WRAPPER
          chmod 755 %{buildroot}%{_bindir}/elementary-l10n
          install -Dm644 data/se.danielnylander.TranslationStatus.desktop %{buildroot}%{_datadir}/applications/se.danielnylander.TranslationStatus.desktop
          install -Dm644 data/icons/se.danielnylander.elementary-l10n.svg %{buildroot}%{_datadir}/icons/hicolor/scalable/apps/se.danielnylander.elementary-l10n.svg
          install -Dm644 data/icons/elementary-l10n.svg %{buildroot}%{_datadir}/icons/hicolor/scalable/apps/elementary-l10n.svg
          install -Dm644 data/man/elementary-l10n.1 %{buildroot}%{_mandir}/man1/elementary-l10n.1
          install -Dm644 data/se.danielnylander.TranslationStatus.metainfo.xml %{buildroot}%{_datadir}/metainfo/se.danielnylander.TranslationStatus.metainfo.xml
          test -f po/sv/LC_MESSAGES/elementary-l10n.mo && install -Dm644 po/sv/LC_MESSAGES/elementary-l10n.mo %{buildroot}%{_datadir}/locale/sv/LC_MESSAGES/elementary-l10n.mo || true

          %files
          %license COPYING
          %{_bindir}/elementary-l10n
          %{_datadir}/elementary-l10n/
          %{_datadir}/applications/se.danielnylander.TranslationStatus.desktop
          %{_datadir}/icons/hicolor/scalable/apps/se.danielnylander.elementary-l10n.svg
          %{_datadir}/icons/hicolor/scalable/apps/elementary-l10n.svg
          %{_mandir}/man1/elementary-l10n.1*
          %{_datadir}/metainfo/se.danielnylander.TranslationStatus.metainfo.xml
          %{_datadir}/locale/sv/LC_MESSAGES/elementary-l10n.mo

          %changelog
          * $(date "+%a %b %d %Y") Daniel Nylander <daniel@danielnylander.se> - VERSION_PLACEHOLDER-1
          - RPM package
          SPEC
          sed -i "s/VERSION_PLACEHOLDER/${{ steps.version.outputs.version }}/g" ~/rpmbuild/SPECS/elementary-l10n.spec

      - name: Build RPM
        run: rpmbuild -ba ~/rpmbuild/SPECS/elementary-l10n.spec

      - name: Upload RPM to release
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TAG=${{ github.event.release.tag_name }}
          gh release upload "$TAG" \
            ~/rpmbuild/RPMS/noarch/elementary-l10n-${VERSION}-1.noarch.rpm \
            --clobber
