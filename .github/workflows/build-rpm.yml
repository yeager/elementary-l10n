name: Build RPM

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install RPM tools
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: Get version
        id: version
        run: echo "version=$(grep -oP '__version__ = \"\K[^\"]+' src/elementary_l10n/__init__.py)" >> $GITHUB_OUTPUT

      - name: Setup RPM build
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p elementary-l10n-$VERSION/src/elementary_l10n
          mkdir -p elementary-l10n-$VERSION/data/icons
          cp src/elementary_l10n/*.py elementary-l10n-$VERSION/src/elementary_l10n/
          cp data/se.danielnylander.TranslationStatus.desktop elementary-l10n-$VERSION/data/
          cp data/icons/elementary-l10n.svg elementary-l10n-$VERSION/data/icons/
          cp data/icons/se.danielnylander.elementary-l10n.svg elementary-l10n-$VERSION/data/icons/
          mkdir -p elementary-l10n-$VERSION/data/man
          cp data/man/elementary-l10n.1 elementary-l10n-$VERSION/data/man/
          cp data/se.danielnylander.TranslationStatus.metainfo.xml elementary-l10n-$VERSION/data/
          cp COPYING elementary-l10n-$VERSION/
          if [ -d locale ]; then
            cp -r locale elementary-l10n-$VERSION/
          fi
          tar czf ~/rpmbuild/SOURCES/elementary-l10n-$VERSION.tar.gz elementary-l10n-$VERSION

      - name: Create spec file
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cat > ~/rpmbuild/SPECS/elementary-l10n.spec << SPEC
Name:           elementary-l10n
Version:        $VERSION
Release:        1
Summary:        elementary-l10n
License:        GPL-3.0-or-later
URL:            https://github.com/yeager/elementary-l10n
Source0:        %{name}-%{version}.tar.gz
BuildArch:      noarch
Requires:       python3 >= 3.9
Requires:       python3-gobject
Requires:       gtk4
Requires:       libadwaita
Requires:       python3-requests

%description
elementary-l10n application.

%prep
%setup -q

%install
mkdir -p %{buildroot}%{_datadir}/elementary-l10n
cp src/elementary_l10n/*.py %{buildroot}%{_datadir}/elementary-l10n/
mkdir -p %{buildroot}%{_bindir}
cat > %{buildroot}%{_bindir}/elementary-l10n << 'WRAPPER'
#!/bin/bash
exec python3 %{_datadir}/elementary-l10n/app.py "\$@"
WRAPPER
chmod 755 %{buildroot}%{_bindir}/elementary-l10n
install -Dm644 data/se.danielnylander.TranslationStatus.desktop %{buildroot}%{_datadir}/applications/se.danielnylander.TranslationStatus.desktop
install -Dm644 data/icons/elementary-l10n.svg %{buildroot}%{_datadir}/icons/hicolor/scalable/apps/elementary-l10n.svg
install -Dm644 data/icons/se.danielnylander.elementary-l10n.svg %{buildroot}%{_datadir}/icons/hicolor/scalable/apps/se.danielnylander.elementary-l10n.svg
install -Dm644 data/man/elementary-l10n.1 %{buildroot}%{_mandir}/man1/elementary-l10n.1
install -Dm644 data/se.danielnylander.TranslationStatus.metainfo.xml %{buildroot}%{_datadir}/metainfo/se.danielnylander.TranslationStatus.metainfo.xml
if [ -d locale ]; then
  for mo in locale/*/LC_MESSAGES/*.mo; do
    [ -f "\$mo" ] || continue
    lang=\$(echo "\$mo" | cut -d/ -f2)
    install -Dm644 "\$mo" "%{buildroot}%{_datadir}/locale/\$lang/LC_MESSAGES/elementary-l10n.mo"
  done
fi

%files
%license COPYING
%{_bindir}/elementary-l10n
%{_datadir}/elementary-l10n/
%{_datadir}/applications/se.danielnylander.TranslationStatus.desktop
%{_datadir}/icons/hicolor/scalable/apps/elementary-l10n.svg
%{_datadir}/icons/hicolor/scalable/apps/se.danielnylander.elementary-l10n.svg
%{_mandir}/man1/elementary-l10n.1*
%{_datadir}/metainfo/se.danielnylander.TranslationStatus.metainfo.xml

%changelog
* Mon Feb 16 2026 Daniel Nylander <daniel@danielnylander.se> - $VERSION-1
- RPM package
SPEC

      - name: Build RPM
        run: rpmbuild -ba ~/rpmbuild/SPECS/elementary-l10n.spec

      - name: Upload RPM to release
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          gh release upload "v${VERSION}" \
            ~/rpmbuild/RPMS/noarch/elementary-l10n-${VERSION}-1.noarch.rpm \
            --clobber
